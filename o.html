<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Custom Video Player</title>
  <script src="https://cdn.jsdelivr.net/npm/@oplayer/core@latest/dist/index.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@oplayer/ui@latest/dist/index.min.js"></script>
  <style>
 body,
html {
  margin: 0;
  padding: 0;
  width: 100%;
  width: 100svw;
  height: 100vh;
  height: 100svh;
  font-family: Arial, Helvetica, sans-serif;
}

@media (min-width: 640px) {
  * {
    user-select: none !important;
    -webkit-user-select: none !important;
    -khtml-user-select: none !important;
    -moz-user-select: none !important;
    -ms-user-select: none !important;
  }
}

a,
button,
img {
  -webkit-tap-highlight-color: rgba(255, 255, 255, 0) !important;
  -webkit-tap-highlight-color: transparent !important;
}

button {
  border-radius: 0.35rem !important;
}

.spinner {
  animation: spinner 0.9s infinite linear;
}

@keyframes spinner {
  0% {
    transform: rotate(0deg);
  }

  100% {
    transform: rotate(360deg);
  }
}

#oplayer {
  width: 100% !important;
  height: 100% !important;
}

video {
  height: 100% !important;
  max-width: 100%;
  object-position: center;
  object-fit: contain !important;
}

/* overriding */
.css-1ftojuw {
  --primary-color: white !important;
}

.css-1xk8bpn {
  width: calc(100% + 5px);
  margin-left: -2px;
}

.css-1gyrt30[aria-checked='true'] .css-l3w6ir {
  background-color: white !important;
}

#oplayer .css-l3w6ir::before {
  background-color: black;
}

#oplayer [aria-label='Setting'],
#oplayer .playlist,
#oplayer .css-fy6n4p {
  border-radius: 1rem;
  background-color: rgba(0, 0, 0, 0.75);
  /* backdrop-filter: blur(5px); */
}

#oplayer [role='menu'] {
  padding: 0.5rem;
  min-width: 18rem;
}

@media (min-width: 640px) {
  [role='menu'] {
    min-width: 20rem;
  }
}

@media (min-width: 1280px) {
  [role='menu'] {
    min-width: 22rem;
  }
}

[role='menuitem'] {
  border-radius: 0.7rem;
  overflow: hidden;
  height: 2.8rem;
}

[role='menuitem'] div {
  height: 100%;
}

#oplayer [role='menuitemradio'] {
  border-radius: 0.5rem;
  overflow: hidden;
  justify-content: start !important;
  gap: 1rem !important;
  height: 2.8rem;
  font-size: 0.85rem !important;
}

[role='menuitemradio'] svg {
  order: -9999 !important;
  -ms-flex-order: -9999 !important;
  display: block !important;
  opacity: 0;
}

[role='menuitemradio'][aria-checked='true'] svg {
  opacity: 1 !important;
}

[aria-label='Play'][type='button'] {
  background: transparent !important;
}

[aria-label='Play'][type='button']::before {
  content: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Crect width='24' height='24' fill='none'/%3E%3Cpath fill='white' fill-rule='evenodd' d='M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2S2 6.477 2 12s4.477 10 10 10' clip-rule='evenodd' opacity='0.4'/%3E%3Cpath fill='white' d='m15.414 13.059l-4.72 2.787C9.934 16.294 9 15.71 9 14.786V9.214c0-.924.934-1.507 1.694-1.059l4.72 2.787c.781.462.781 1.656 0 2.118'/%3E%3C/svg%3E");
  width: 4rem;
  height: 4rem;
  display: block;
  /* filter: drop-shadow(0 10px 8px rgb(0 0 0 / 0.04)) drop-shadow(0 4px 3px rgb(0 0 0 / 0.1)); */
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  flex-shrink: 0;
}

@media (min-width: 1280px) {
  [aria-label='Play'][type='button']::before {
    width: 5rem;
    height: 5rem;
  }
}

@media (max-width: 640px) {
  [aria-label='Screenshot'] {
    display: none !important;
  }
}

#oplayer .playlist-list-item {
  margin: 0 0.5rem 0.5rem;
  border-radius: 0.7rem;
  border: none;
}

#oplayer .playlist-head {
  border-bottom: none;
  background: transparent;
}

.playlist-list-item-thumb,
.playlist-list-item-thumb img {
  border-radius: 0.5rem;
}

.playlist-back {
  border-radius: 0.35rem !important;
}

.css-1y9tj12 {
  padding-top: 0.5em;
    }
  </style>
</head>
<body>
  <div id="oplayer-container">
  <div id="oplayer"></div>
</div>

<style>
  /* Import a custom font */
  @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap');

  body {
    font-family: 'Roboto', sans-serif;
    background-color: #f0f0f0;
    margin: 0;
  }

  #oplayer-container {
    position: relative;
    width: 100%;
    max-width: 800px; /* Adjust player size */
    margin: 0 auto;
  }

  #next-episode-btn {
    display: none;
    position: absolute;
    bottom: 10%;
    right: 10%;
    padding: 10px 20px;
    font-size: 14px;
    background-color: #ccc;
    color: transparent;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    overflow: hidden;
    text-transform: uppercase;
    letter-spacing: 1px;
    font-weight: bold;
    z-index: 10;
    transition: all 0.3s ease;
  }

  #next-episode-btn::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    width: 0;
    height: 100%;
    background-color: #fff;
    z-index: 1;
    transition: width 1s ease-in-out;
  }

  #next-episode-btn.loaded::before {
    width: 100%;
  }

  #next-episode-btn span {
    position: relative;
    z-index: 2;
    color: #333;
    transition: color 1s ease-in-out;
  }

  #next-episode-btn.loaded span {
    color: #333;
  }
</style>

<script>
  // Utility to get URL parameters
  function getParam(param) {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(param);
  }

  // Redirect to index.html on error
  function redirectToIndex() {
    window.location.href = 'index.html';
  }

  // Function to go to the next episode
  function goToNextEpisode(currentId) {
    const parts = currentId.split('-');
    const episodeNumber = parseInt(parts.pop());
    if (!isNaN(episodeNumber)) {
      parts.push(episodeNumber + 1);
      const nextEpisodeId = parts.join('-');
      const nextUrl = `?id=${nextEpisodeId}`;
      window.location.href = nextUrl;
    } else {
      console.error("Failed to parse episode ID");
    }
  }

  // Load video info from API using the ID from URL parameters
  async function loadVideoData() {
    const id = getParam('id');
    const apiUrl = `https://api-p1xr.vercel.app/api/v2/stream/${id}`;

    try {
      const response = await fetch(apiUrl);

      // Redirect if API returns error
      if (response.status === 500) {
        redirectToIndex();
        return;
      }

      const data = await response.json();

      if (data.code === 200 && data.info && data.stream) {
        initializePlayer(data);
      } else {
        console.error("Failed to fetch video data.");
      }
    } catch (error) {
      console.error("API error:", error);
      redirectToIndex();
    }
  }

  // Initialize OPlayer with video data and add button functionality
  function initializePlayer(data) {
    const { title } = data.info;
    const { url, isM3U8 } = data.stream.multi.main;
    const thumbnailUrl = data.stream.tracks.file;

    const player = OPlayer.make('#oplayer', {
      source: {
        title: title,
        src: url,
        type: isM3U8 ? 'application/x-mpegURL' : 'video/mp4',
        poster: 'https://cdn.jsdelivr.net/gh/shiyiya/QI-ABSL@master/o/poster.png',
        thumbnails: {
          src: thumbnailUrl
        }
      },
    })
      .use([OUI()])
      .create();

    // Check local storage for saved time and resume if available
    const savedTime = localStorage.getItem(`progress-${data.info.id}`);
    if (savedTime) {
      player.seek(Number(savedTime));
    }

    // Save progress every second
    player.on('timeupdate', () => {
      localStorage.setItem(`progress-${data.info.id}`, player.currentTime());

      // Show the button 5 minutes before the video ends
      if (player.duration() - player.currentTime() <= 300) {
        const nextButton = document.getElementById('next-episode-btn');
        nextButton.style.display = 'block';
        nextButton.classList.add('loaded');
      }
    });

    // Remove progress when video ends
    player.on('ended', () => {
      localStorage.removeItem(`progress-${data.info.id}`);
    });

    // Handle next episode button click
    const nextButton = document.createElement('button');
    nextButton.id = 'next-episode-btn';
    nextButton.innerHTML = '<span>Next Episode</span>';
    document.getElementById('oplayer-container').appendChild(nextButton);

    nextButton.addEventListener('click', () => {
      goToNextEpisode(data.info.id);
    });
  }

  // Load video data and initialize player
  loadVideoData();
</script>

</body>
  </html>
  

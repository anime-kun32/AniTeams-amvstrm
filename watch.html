<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Player</title>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        .container {
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #000;
            overflow: hidden;
        }

        .artplayer-app {
            width: 100vw;
            height: 100vh;
            background: #000;
            box-sizing: border-box;
        }

        @media (max-width: 768px) {
            .artplayer-app {
                width: 100vw;
                height: 100vh;
            }
        }

        @media (max-width: 1024px) {
            .artplayer-app {
                width: 100vw;
                height: 100vh;
            }
        }

        /* Spinner CSS */
        .ytp-spinner {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background: rgba(255, 255, 255, 0.8);
            z-index: 9999;
        }
        .ytp-spinner-container {
            display: inline-block;
        }
        .ytp-spinner-rotator {
            width: 50px;
            height: 50px;
            position: relative;
            transform: rotate(0deg);
            animation: spin 1.2s linear infinite;
        }
        .ytp-spinner-left, .ytp-spinner-right {
            width: 50px;
            height: 50px;
            position: absolute;
            border: 3px solid #000;
            border-radius: 50%;
            border-top-color: transparent;
            border-bottom-color: transparent;
        }
        .ytp-spinner-left {
            left: 0;
            border-right-color: transparent;
            animation: rotate 1.2s linear infinite;
        }
        .ytp-spinner-right {
            right: 0;
            border-left-color: transparent;
            animation: rotate-reverse 1.2s linear infinite;
        }
        .ytp-spinner-circle {
            position: absolute;
            border-radius: 50%;
            border: 3px solid transparent;
            border-top-color: #000;
            width: 50px;
            height: 50px;
            animation: spin-circle 1.2s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @keyframes rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @keyframes rotate-reverse {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(-360deg); }
        }
        @keyframes spin-circle {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="ytp-spinner">
        <div>
            <div class="ytp-spinner-container">
                <div class="ytp-spinner-rotator">
                    <div class="ytp-spinner-left">
                        <div class="ytp-spinner-circle"></div>
                    </div>
                    <div class="ytp-spinner-right">
                        <div class="ytp-spinner-circle"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="artplayer-app"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/artplayer/dist/artplayer.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/artplayer-plugin-chromecast/dist/artplayer-plugin-chromecast.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const baseApiUrl = 'https://api-p1xr.vercel.app/api/v2/stream'; // Base URL for the API
            let art = null; // Variable to store the Artplayer instance

            // Function to extract query parameters from the URL
            const getQueryParam = (param) => {
                const urlParams = new URLSearchParams(window.location.search);
                return urlParams.get(param);
            };

            // Get the ID from the URL
            const id = getQueryParam('id');
            if (!id) {
                console.error('No ID provided in URL');
                return;
            }

            // Fetch video data from the API
            const fetchVideoData = () => {
                const apiUrl = `${baseApiUrl}/${id}`;
                console.log(`Fetching video data from: ${apiUrl}`); // Debug log
                return fetch(apiUrl)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .catch(error => {
                        console.error('Error fetching API data:', error);
                    });
            };

            // Function to save the current time to local storage
            const saveCurrentTime = (videoId, time) => {
                localStorage.setItem(`lastSeen-${videoId}`, time);
            };

            // Function to get the last seen time from local storage
            const getLastSeenTime = (videoId) => {
                return localStorage.getItem(`lastSeen-${videoId}`);
            };

            // Initialize or reinitialize the player with the new data
            const initializePlayer = (data) => {
                if (!data || !data.stream || !data.stream.multi || !data.stream.multi.main || !data.stream.multi.backup) {
                    console.error('Invalid data received from API:', data); // Debug log
                    return;
                }

                const videoSource = data.stream.multi.main.url;
                const backupSource = data.stream.multi.backup.url;
                const thumbnailTrack = data.stream.tracks && data.stream.tracks.kind === 'thumbnails' ? {
                    label: "Thumbnails",
                    file: data.stream.tracks.file
                } : null;

                // Set the document title based on the API response
                document.title = data.info.title;

                // Get the last seen time from local storage
                const lastSeenTime = getLastSeenTime(id);

                // Destroy the existing player if it exists
                if (art) {
                    art.destroy();
                }

                art = new Artplayer({
                    container: '.artplayer-app',
                    url: videoSource,
                    type: 'm3u8',
                    screenshot: true,
                    setting: true,
                    autoplay: true,
                    fullscreen: true,
                    fullscreenWeb: true,
                    airplay: true,
                    playsInline: true,
                    plugins: [
                        artplayerPluginChromecast({}),
                    ],
                    settings: [
                        {
                            html: 'Speed',
                            selector: [
                                { html: '1.0x', playbackRate: 1.0, default: true },
                                { html: '1.5x', playbackRate: 1.5 },
                                { html: '2.0x', playbackRate: 2.0 },
                            ],
                            onSelect: function (item) {
                                art.playbackRate = item.playbackRate;
                                return item.html;
                            },
                        },
                        {
                            html: 'Source',
                            selector: [
                                { html: 'Main', url: videoSource, default: true },
                                { html: 'Backup', url: backupSource },
                            ],
                            onSelect: function (item) {
                                art.switchUrl(item.url);
                                return item.html;
                            },
                        },
                        {
                            html: 'Jump Forward',
                            selector: [
                                { html: '10s', time: 10 },
                                { html: '30s', time: 30 },
                                { html: '60s', time: 60 },
                            ],
                            onSelect: function (item) {
                                art.currentTime += item.time;
                                return item.html;
                            },
                        },
                        {
                            html: 'Jump Backward',
                            selector: [
                                { html: '10s', time: -10 },
                                { html: '30s', time: -30 },
                                { html: '60s', time: -60 },
                            ],
                            onSelect: function (item) {
                                art.currentTime += item.time;
                                return item.html;
                            },
                        },
                    ],
                    customType: {
                        m3u8: function (video, url) {
                            if (Hls.isSupported()) {
                                const hls = new Hls();
                                hls.loadSource(url);
                                hls.attachMedia(video);
                                hls.on(Hls.Events.MANIFEST_PARSED, () => {
                                    video.play();
                                });
                            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                                video.src = url;
                                video.addEventListener('loadedmetadata', () => {
                                    video.play();
                                });
                            } else {
                                art.notice.show('Does not support playback of m3u8');
                            }
                        }
                    },
                    moreVideoAttr: {
                        'webkit-playsinline': true,
                        'playsinline': true,
                    },
                    lock: true, // Enable control lock feature
                });

                // Event listener to save the current time periodically
                art.on('video:timeupdate', () => {
                    saveCurrentTime(id, art.currentTime);
                });

                // Check for last seen time and prompt the user
                if (lastSeenTime) {
                    art.notice.show(
                        `Resume from last seen position?`,
                        [
                            {
                                html: 'Yes',
                                onClick: () => {
                                    art.currentTime = parseFloat(lastSeenTime);
                                    art.notice.hide();
                                },
                            },
                            {
                                html: 'No',
                                onClick: () => {
                                    art.notice.hide();
                                },
                            },
                        ],
                        5000,
                    );
                }

                // Create and style the back button
                const backButton = document.createElement('div');
                backButton.innerHTML = '&lt;'; // HTML entity for "<"
                backButton.style.position = 'absolute';
                backButton.style.top = '10px';
                backButton.style.left = '10px';
                backButton.style.fontSize = '24px';
                backButton.style.color = 'white';
                backButton.style.cursor = 'pointer';
                backButton.style.zIndex = '9999';

                // Add click event to the back button
                backButton.addEventListener('click', () => {
                    window.history.back();
                });

                // Append the back button to the player container
                const playerContainer = document.querySelector('.artplayer-app');
                playerContainer.appendChild(backButton);

                // Listen for fullscreen change events to rotate the screen on mobile devices
                art.on('fullscreen', (state) => {
                    if (state) {
                        // Entering fullscreen
                        screen.orientation.lock('landscape').catch(() => {
                            console.error('Screen orientation lock failed');
                        });
                    } else {
                        // Exiting fullscreen
                        screen.orientation.unlock().catch(() => {
                            console.error('Screen orientation unlock failed');
                        });
                    }
                });

                // Hide the spinner once the player is initialized
                document.querySelector('.ytp-spinner').style.display = 'none';
            };

            // Fetch the initial video data and initialize the player
            fetchVideoData().then(initializePlayer);
        });
    </script>
</body>
</html>

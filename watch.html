<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Artplayer with Quality Control</title>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }

    .container {
      width: 100vw;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      background: #000;
      overflow: hidden;
    }

    .artplayer-app {
      width: 100vw;
      height: 100vh;
      background: #000;
      box-sizing: border-box;
    }
  </style>
</head>
<body>
  <div class="artplayer-app"></div>

  <script src="https://cdn.jsdelivr.net/npm/artplayer/dist/artplayer.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/artplayer-plugin-chromecast/dist/artplayer-plugin-chromecast.js"></script>
<script src="https://cdn.jsdelivr.net/npm/eruda"></script>
<script>eruda.init();</script>
  <script>
    
  document.addEventListener('DOMContentLoaded', () => {
    const baseApiUrl = 'https://api-consumet-org-gamma.vercel.app/meta/anilist/watch';
    let art = null;
    let hls = null;

    const getQueryParam = (param) => {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(param);
    };

    const id = getQueryParam('id');
    if (!id) {
        console.error('No ID provided in URL');
        return;
    }

    const fetchVideoData = () => {
        const apiUrl = `${baseApiUrl}/${id}`;
        return fetch(apiUrl, {
            headers: {
                'Referer': 'https://s3embtaku.pro',
            },
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .catch(error => {
            console.error('Error fetching API data:', error);
        });
    };

    const initializePlayer = (data) => {
        if (!data || !data.sources || !Array.isArray(data.sources)) {
            console.error('Invalid data received from API:', data);
            return;
        }

        const defaultSource = data.sources.find(source => source.quality === 'default');
        const backupSource = data.sources.find(source => source.quality === 'backup');

        if (!defaultSource || !backupSource) {
            console.error('Default or backup source not found in API response');
            return;
        }

        const videoSource = defaultSource.url;
        const backupSourceUrl = backupSource.url;
        let currentSource = videoSource; // Initially set to the default source

        document.title = data.info.title;

        if (art) {
            art.destroy();
        }

        const switchQuality = (level) => {
            if (hls) {
                if (level === 'auto') {
                    hls.currentLevel = -1; // Auto
                } else {
                    const qualityIndex = hls.levels.findIndex(l => l.height.toString() === level);
                    if (qualityIndex !== -1) {
                        hls.currentLevel = qualityIndex;
                    }
                }
            }
        };

        const switchServer = (url) => {
            if (art) {
                art.switchUrl(url);
                if (hls) {
                    hls.loadSource(url);
                    hls.attachMedia(art.video);
                }
            }
        };

        art = new Artplayer({
            container: '.artplayer-app',
            url: currentSource,
            type: 'm3u8',
            screenshot: true,
            setting: true,
            autoplay: true,
            fullscreen: true,
            fullscreenWeb: true,
            airplay: true,
            playsInline: true,
            plugins: [
                artplayerPluginChromecast({}),
            ],
            settings: [
                {
                    html: 'Server',
                    selector: [
                        { html: 'Default', url: videoSource, default: true },
                        { html: 'Backup', url: backupSourceUrl },
                    ],
                    onSelect: function (item) {
                        currentSource = item.url;
                        switchServer(item.url);
                        return item.html;
                    },
                },
                {
                    html: 'Quality',
                    selector: [
                        { html: 'Auto', value: 'auto', default: true },
                        { html: '360p', value: '360' },
                        { html: '480p', value: '480' },
                        { html: '720p', value: '720' },
                        { html: '1080p', value: '1080' },
                    ],
                    onSelect: function (item) {
                        switchQuality(item.value);
                        return item.html;
                    },
                },
            ],
            customType: {
                m3u8: function (video, url) {
                    if (Hls.isSupported()) {
                        hls = new Hls();
                        hls.loadSource(url);
                        hls.attachMedia(video);
                        hls.on(Hls.Events.MANIFEST_PARSED, () => {
                            video.play();
                        });
                    } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                        video.src = url;
                        video.addEventListener('loadedmetadata', () => {
                            video.play();
                        });
                    } else {
                        art.notice.show('Does not support playback of m3u8');
                    }
                }
            },
        });

        art.on('video:timeupdate', () => {
            localStorage.setItem(`lastSeen-${id}`, art.currentTime);
        });

        const lastSeenTime = localStorage.getItem(`lastSeen-${id}`);
        if (lastSeenTime) {
            art.notice.show(
                `Resume from last seen position?`,
                [
                    {
                        html: 'Yes',
                        onClick: () => {
                            art.currentTime = parseFloat(lastSeenTime);
                            art.notice.hide();
                        },
                    },
                    {
                        html: 'No',
                        onClick: () => {
                            art.notice.hide();
                        },
                    },
                ],
                5000,
            );
        }
    };

    fetchVideoData().then(initializePlayer);
  });
  </script>
</body>
</html>
